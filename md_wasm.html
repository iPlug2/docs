<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>iPlug 2: Building WASM Plugins</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 80px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">iPlug2 - C++ Audio Plug-in Framework
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Building WASM Plugins </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >iPlug2 supports compiling plugins to WebAssembly (WASM) for running in web browsers. This guide covers the modern split DSP/UI architecture.</p>
<h1><a class="anchor" id="autotoc_md92"></a>
Architecture Overview</h1>
<p >The WASM build system creates two separate modules:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Module   </th><th class="markdownTableHeadNone">Thread   </th><th class="markdownTableHeadNone">Purpose    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>DSP</b>   </td><td class="markdownTableBodyNone">AudioWorklet   </td><td class="markdownTableBodyNone">Audio processing, runs in real-time audio thread    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>UI</b>   </td><td class="markdownTableBodyNone">Main   </td><td class="markdownTableBodyNone"><a class="el" href="class_i_graphics.html" title="The lowest level base class of an IGraphics context.">IGraphics</a> rendering, user interaction   </td></tr>
</table>
<p >Communication between modules uses <code>postMessage</code> for parameters/MIDI and optionally <code>SharedArrayBuffer</code> for low-latency visualization data.</p>
<h2><a class="anchor" id="autotoc_md93"></a>
Why Split Architecture?</h2>
<ul>
<li><b>Audio thread isolation</b>: DSP runs in AudioWorklet, isolated from main thread jank</li>
<li><b>Smaller initial load</b>: DSP module embedded as BASE64, UI loads asynchronously</li>
<li><b>No WAM SDK dependency</b>: Uses standard Web Audio API directly</li>
<li><b>Shadow DOM support</b>: UI encapsulated for embedding in web pages</li>
<li><b>Multi-instance support</b>: Multiple plugin instances can run in the same AudioContext</li>
</ul>
<h1><a class="anchor" id="autotoc_md94"></a>
Prerequisites</h1>
<h2><a class="anchor" id="autotoc_md95"></a>
Install Emscripten</h2>
<div class="fragment"><div class="line">cd ~</div>
<div class="line">git clone https://github.com/emscripten-core/emsdk.git</div>
<div class="line">cd emsdk</div>
<div class="line">./emsdk install latest</div>
<div class="line">./emsdk activate latest</div>
<div class="line">source ./emsdk_env.sh</div>
</div><!-- fragment --><p >Add <code>source ~/emsdk/emsdk_env.sh</code> to your shell profile for persistence.</p>
<h2><a class="anchor" id="autotoc_md96"></a>
Server Requirements</h2>
<p >For <code>SharedArrayBuffer</code> support (needed for visualization data), your server must send these headers:</p>
<div class="fragment"><div class="line">Cross-Origin-Opener-Policy: same-origin</div>
<div class="line">Cross-Origin-Embedder-Policy: require-corp</div>
</div><!-- fragment --><p >Without these headers, the plugin will fall back to <code>postMessage</code> for all communication (higher latency for visualization).</p>
<h1><a class="anchor" id="autotoc_md97"></a>
Building with Makefile</h1>
<p >Each example project has a <code>makedist-wasm.sh</code> script:</p>
<div class="fragment"><div class="line">cd Examples/IPlugEffect/scripts</div>
<div class="line">./makedist-wasm.sh        # Build and launch in Chrome</div>
<div class="line">./makedist-wasm.sh off    # Build only, don&#39;t launch browser</div>
<div class="line">./makedist-wasm.sh on safari  # Build and launch in Safari</div>
</div><!-- fragment --><p >The script:</p><ol type="1">
<li>Packages resources (fonts, images, SVGs)</li>
<li>Builds DSP module with <code>SINGLE_FILE=1</code> (BASE64 embedded)</li>
<li>Builds UI module (if <code>PLUG_HAS_UI=1</code>)</li>
<li>Copies templates and generates the web bundle</li>
<li>Outputs to <code>build-web-wasm/</code></li>
</ol>
<h2><a class="anchor" id="autotoc_md98"></a>
Headless Plugins</h2>
<p >For plugins without <a class="el" href="class_i_graphics.html" title="The lowest level base class of an IGraphics context.">IGraphics</a> (<code>PLUG_HAS_UI=0</code>), only the DSP module is built. The template auto-generates parameter controls.</p>
<h1><a class="anchor" id="autotoc_md99"></a>
Building with CMake</h1>
<div class="fragment"><div class="line">cd Examples/IPlugEffect</div>
<div class="line">mkdir build &amp;&amp; cd build</div>
<div class="line">cmake .. -DTARGET_WASM=ON -G Ninja</div>
<div class="line">ninja</div>
</div><!-- fragment --><p >Or with Xcode generator: </p><div class="fragment"><div class="line">cmake .. -DTARGET_WASM=ON -G Xcode</div>
</div><!-- fragment --><p >CMake targets:</p><ul>
<li><code>IPlugEffect-wasm-dsp</code> - DSP module</li>
<li><code>IPlugEffect-wasm-ui</code> - UI module</li>
<li><code>IPlugEffect-wasm-dist</code> - Full distribution bundle</li>
</ul>
<h1><a class="anchor" id="autotoc_md100"></a>
Project Configuration</h1>
<h2><a class="anchor" id="autotoc_md101"></a>
Makefile Config</h2>
<p >Create <code>config/YourPlugin-wasm.mk</code>:</p>
<div class="fragment"><div class="line"># Project-specific settings</div>
<div class="line">PLUG_NAME = YourPlugin</div>
<div class="line"> </div>
<div class="line"># Extra source files</div>
<div class="line">EXTRA_SRC = $(PROJECT_ROOT)/MyDSP.cpp</div>
<div class="line"> </div>
<div class="line"># Extra include paths</div>
<div class="line">EXTRA_INCLUDES = -I$(PROJECT_ROOT)/libs</div>
<div class="line"> </div>
<div class="line"># Extra defines</div>
<div class="line">EXTRA_CFLAGS = -DUSE_MY_FEATURE=1</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md102"></a>
DSP/UI Project Files</h2>
<p >Create separate project files for DSP and UI modules:</p>
<p >**<code>projects/YourPlugin-wasm-dsp.mk</code>**: </p><div class="fragment"><div class="line">include $(IPLUG2_ROOT)/common-wasm.mk</div>
<div class="line">include ../config/YourPlugin-wasm.mk</div>
</div><!-- fragment --><p >**<code>projects/YourPlugin-wasm-ui.mk</code>**: </p><div class="fragment"><div class="line">include $(IPLUG2_ROOT)/common-wasm.mk</div>
<div class="line">include ../config/YourPlugin-wasm.mk</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md103"></a>
Message Protocol</h1>
<p >DSP and UI communicate via typed messages:</p>
<h2><a class="anchor" id="autotoc_md104"></a>
UI → DSP (via &lt;tt&gt;postMessage&lt;/tt&gt;)</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Fields   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>param</code>   </td><td class="markdownTableBodyNone"><code>paramIdx</code>, <code>value</code>   </td><td class="markdownTableBodyNone">Parameter change    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>midi</code>   </td><td class="markdownTableBodyNone"><code>status</code>, <code>data1</code>, <code>data2</code>   </td><td class="markdownTableBodyNone">MIDI message    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>sysex</code>   </td><td class="markdownTableBodyNone"><code>data</code> (ArrayBuffer)   </td><td class="markdownTableBodyNone">SysEx message    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>arbitrary</code>   </td><td class="markdownTableBodyNone"><code>msgTag</code>, <code>ctrlTag</code>, <code>data</code>   </td><td class="markdownTableBodyNone">Custom message    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>tick</code>   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">Idle tick (flush queued messages)   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md105"></a>
DSP → UI (via &lt;tt&gt;postMessage&lt;/tt&gt;)</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Verb   </th><th class="markdownTableHeadNone">Fields   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>SPVFD</code>   </td><td class="markdownTableBodyNone"><code>paramIdx</code>, <code>value</code>   </td><td class="markdownTableBodyNone">Parameter value from DSP    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>SCVFD</code>   </td><td class="markdownTableBodyNone"><code>ctrlTag</code>, <code>value</code>   </td><td class="markdownTableBodyNone">Control value (visualization)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>SCMFD</code>   </td><td class="markdownTableBodyNone"><code>ctrlTag</code>, <code>msgTag</code>, <code>data</code>   </td><td class="markdownTableBodyNone">Control message    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>SAMFD</code>   </td><td class="markdownTableBodyNone"><code>msgTag</code>, <code>data</code>   </td><td class="markdownTableBodyNone">Arbitrary message    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>SSMFD</code>   </td><td class="markdownTableBodyNone"><code>data</code>   </td><td class="markdownTableBodyNone">SysEx from DSP    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>pluginInfo</code>   </td><td class="markdownTableBodyNone"><code>data</code>   </td><td class="markdownTableBodyNone">Plugin metadata (params, channels)   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md106"></a>
SharedArrayBuffer (Low-Latency Path)</h2>
<p >For high-frequency visualization data, <code>SCVFD</code>/<code>SCMFD</code>/<code>SAMFD</code> can use a ring buffer in <code>SharedArrayBuffer</code>:</p>
<div class="fragment"><div class="line">Header (16 bytes):</div>
<div class="line">  [0-3]   writeIdx (Uint32, atomic)</div>
<div class="line">  [4-7]   readIdx (Uint32, atomic)</div>
<div class="line">  [8-11]  capacity (Uint32)</div>
<div class="line">  [12-15] reserved</div>
<div class="line"> </div>
<div class="line">Message:</div>
<div class="line">  [0]     msgType (0=SCVFD, 1=SCMFD, 2=SAMFD)</div>
<div class="line">  [1]     reserved</div>
<div class="line">  [2-3]   dataSize (Uint16)</div>
<div class="line">  [4-7]   ctrlTag (Int32)</div>
<div class="line">  [8-11]  msgTag (Int32)</div>
<div class="line">  [12+]   payload</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md107"></a>
Template Files</h1>
<p >The build copies templates from <code>IPlug/WEB/TemplateWasm/</code>:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">File   </th><th class="markdownTableHeadNone">Purpose    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>index.html</code>   </td><td class="markdownTableBodyNone">Main page with Web Audio setup    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>scripts/IPlugWasmBundle.js.template</code>   </td><td class="markdownTableBodyNone">Controller class, connects DSP↔UI    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>scripts/IPlugWasmProcessor.js.template</code>   </td><td class="markdownTableBodyNone">AudioWorkletProcessor wrapper    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>styles/style.css</code>   </td><td class="markdownTableBodyNone">Default styling   </td></tr>
</table>
<p >Placeholders like <code>NAME_PLACEHOLDER</code> are replaced with the plugin name during build.</p>
<h1><a class="anchor" id="autotoc_md108"></a>
Debugging</h1>
<h2><a class="anchor" id="autotoc_md109"></a>
Console Messages</h2>
<p >Both DSP and UI modules log to the browser console. DSP messages are prefixed with the plugin name.</p>
<h2><a class="anchor" id="autotoc_md110"></a>
Common Issues</h2>
<p >**"SharedArrayBuffer is not defined"** Server missing COOP/COEP headers. Plugin will work but visualization data uses slower <code>postMessage</code> path.</p>
<p >**"Module not found in globalThis"** DSP module failed to load. Check browser console for WASM compilation errors.</p>
<p ><b>Audio glitches</b> DSP module may be too heavy. Profile with Chrome DevTools Performance panel. Consider:</p><ul>
<li>Reducing buffer processing</li>
<li>Disabling SIMD if causing issues</li>
<li>Checking for allocations in <code>ProcessBlock</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md111"></a>
Local Development Server</h2>
<p >Python 3 with COOP/COEP headers:</p>
<div class="fragment"><div class="line"><span class="comment">#!/usr/bin/env python3</span></div>
<div class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> HTTPServer, SimpleHTTPRequestHandler</div>
<div class="line"><span class="keyword">import</span> sys</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>CORPHandler(SimpleHTTPRequestHandler):</div>
<div class="line">    <span class="keyword">def </span>end_headers(self):</div>
<div class="line">        self.send_header(<span class="stringliteral">&#39;Cross-Origin-Opener-Policy&#39;</span>, <span class="stringliteral">&#39;same-origin&#39;</span>)</div>
<div class="line">        self.send_header(<span class="stringliteral">&#39;Cross-Origin-Embedder-Policy&#39;</span>, <span class="stringliteral">&#39;require-corp&#39;</span>)</div>
<div class="line">        super().end_headers()</div>
<div class="line"> </div>
<div class="line">    extensions_map = {</div>
<div class="line">        **SimpleHTTPRequestHandler.extensions_map,</div>
<div class="line">        <span class="stringliteral">&#39;.wasm&#39;</span>: <span class="stringliteral">&#39;application/wasm&#39;</span>,</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">port = int(sys.argv[1]) <span class="keywordflow">if</span> len(sys.argv) &gt; 1 <span class="keywordflow">else</span> 8000</div>
<div class="line">print(f<span class="stringliteral">&#39;Serving at http://localhost:{port}&#39;</span>)</div>
<div class="line">HTTPServer((<span class="stringliteral">&#39;localhost&#39;</span>, port), CORPHandler).serve_forever()</div>
</div><!-- fragment --><p >Save as <code>serve.py</code> and run: <code>python3 serve.py 8080</code></p>
<h1><a class="anchor" id="autotoc_md112"></a>
Multi-Instance Support</h1>
<p >The WASM DSP module supports multiple plugin instances running in the same AudioWorklet context. This enables:</p>
<ul>
<li>Multiple instances of the same plugin (e.g., two compressors in a chain)</li>
<li>Plugin chains where audio flows through multiple effects</li>
<li>Hosting multiple plugins in a single web page</li>
</ul>
<h2><a class="anchor" id="autotoc_md113"></a>
How It Works</h2>
<p >Each <code>AudioWorkletProcessor</code> creates its own DSP instance:</p>
<div class="fragment"><div class="line">// In AudioWorkletProcessor constructor</div>
<div class="line">this.instanceId = Module.createInstance();  // Returns unique ID</div>
<div class="line"> </div>
<div class="line">// All calls include instance ID</div>
<div class="line">Module.init(this.instanceId, sampleRate, blockSize);</div>
<div class="line">Module.processBlock(this.instanceId, inputPtrs, outputPtrs, nFrames);</div>
<div class="line">Module.onParam(this.instanceId, paramIdx, value);</div>
</div><!-- fragment --><p >The C++ side maintains an instance registry:</p><ul>
<li><code>createInstance()</code> - allocates new plugin, returns ID</li>
<li><code>destroyInstance(id)</code> - cleans up instance</li>
<li>All other functions take <code>instanceId</code> as first parameter</li>
</ul>
<h2><a class="anchor" id="autotoc_md114"></a>
Instance Lifecycle</h2>
<ol type="1">
<li><b>Create</b>: Processor constructor calls <code>Module.createInstance()</code></li>
<li><b>Register</b>: Processor registers its <code>port</code> for postMessage callbacks</li>
<li><b>Use</b>: All WASM calls include instance ID</li>
<li><b>Destroy</b>: On cleanup, call <code>Module.destroyInstance(instanceId)</code></li>
</ol>
<h2><a class="anchor" id="autotoc_md115"></a>
Memory Considerations</h2>
<p >Each instance has its own:</p><ul>
<li>Plugin state and parameters</li>
<li>Audio buffers (allocated separately per processor)</li>
<li>Message port for DSP→UI communication</li>
</ul>
<p >The WASM module code is shared across all instances, but each instance has isolated state.</p>
<h1><a class="anchor" id="autotoc_md116"></a>
Comparison with WAM Builds</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Feature   </th><th class="markdownTableHeadNone">WASM (Split)   </th><th class="markdownTableHeadNone">WAM    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SDK dependency   </td><td class="markdownTableBodyNone">None   </td><td class="markdownTableBodyNone">WAM SDK required    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Architecture   </td><td class="markdownTableBodyNone">Split DSP/UI   </td><td class="markdownTableBodyNone">Combined    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AudioWorklet   </td><td class="markdownTableBodyNone">Native   </td><td class="markdownTableBodyNone">Via SDK    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Visualization   </td><td class="markdownTableBodyNone">SAB + postMessage   </td><td class="markdownTableBodyNone">WAM events    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">DAW integration   </td><td class="markdownTableBodyNone">Basic   </td><td class="markdownTableBodyNone">WAM host support   </td></tr>
</table>
<p >Use <b>WASM Split</b> for: standalone web plugins, embedding in web apps, simple deployment.</p>
<p >Use <b>WAM</b> for: DAW integration, WAM-compatible hosts, standardized plugin format.</p>
<h1><a class="anchor" id="autotoc_md117"></a>
See Also</h1>
<ul>
<li>How to setup iPlug2 with emscripten</li>
<li>Build a WAM project using Emscripten and Docker</li>
<li>Understanding UI-DSP communication </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
